<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUHS | Terminal v3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { 
            --v3-bg: #0a0a0a; --v3-blue: #3b82f6; --v3-border: #27272a;
            --v1-neon: #00ff41; --v1-bg: #050505; --v1-border: #111;
        }
        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #terminal-master { width: 360px; height: 720px; position: relative; border-radius: 40px; padding: 80px 25px 25px 25px; display: flex; flex-direction: column; box-sizing: border-box; transition: all 0.3s ease; }
        .v3-theme { background: var(--v3-bg); border: 1px solid var(--v3-border); }
        .v1-theme { background: var(--v1-bg); border: 2px solid var(--v1-neon); font-family: 'Courier New', monospace; color: var(--v1-neon); box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }

        #mode-selector { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001; }
        .sw-btn { background: #1a1a1a; border: 1px solid #333; color: #666; padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
        .sw-btn.active { border-color: #fff; color: #fff; }

        #disconnect-btn { position: absolute; top: 80px; right: 25px; border: 1px solid #ff4444; color: #ff4444; background: transparent; padding: 5px 10px; border-radius: 10px; font-size: 0.6rem; cursor: pointer; z-index: 10; }
        .hidden { display: none !important; }

        .data-box { background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 15px; margin-bottom: 12px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; }
        .v1-theme .data-box { border-color: var(--v1-neon); background: rgba(0, 255, 65, 0.05); }
        
        .unit { text-align: center; width: 85px; }
        .large-icon { width: 42px; height: 42px; object-fit: contain; }
        .label-sub { font-size: 0.55rem; color: #666; font-weight: bold; display: block; }
        
        .btn-main { width: 100%; padding: 18px; border: none; border-radius: 18px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        .v3-theme .btn-main { background: #fff; color: #000; }
        .v1-theme .btn-main { background: transparent; color: var(--v1-neon); border: 1px solid var(--v1-neon); border-radius: 4px; text-transform: uppercase; }
        .v1-theme .btn-main:hover { background: var(--v1-neon); color: #000; }
        
        input[type=number] { background: transparent; border: 1px solid #222; color: #fff; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; text-align: center; margin-top: 10px; font-size: 1rem; }

        #jumper-container { display: none; position: absolute; inset: 0; width: 100%; height: 100%; background: #000; z-index: 1000; border-radius: 40px; overflow: hidden; }
        #jumper-iframe { width: 100%; height: 100%; border: none; }
        #close-jumper { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 8px 20px; border-radius: 20px; cursor: pointer; z-index: 1001; }
    </style>
</head>
<body>

    <div id="mode-selector">
        <button id="btn-v3" class="sw-btn active" onclick="setMode('v3')">UTILITY_UI</button>
        <button id="btn-v1" class="sw-btn" onclick="setMode('v1')">NATIVE_OS</button>
    </div>

    <div id="terminal-master" class="v3-theme">
        <button id="disconnect-btn" class="hidden" onclick="disconnectWallet()">DISCONNECT</button>
        
        <div id="jumper-container">
            <button id="close-jumper" onclick="closeJumper()">CLOSE [X]</button>
            <iframe id="jumper-iframe" src=""></iframe>
        </div>

        <div id="section-v3">
            <div style="text-align: center; margin-bottom: 25px;">
                <h1 style="font-size: 0.8rem; color: #888;">BIGTREE_GATEWAY</h1>
                <div id="btg-price" style="font-size: 0.7rem; color: var(--v3-blue);">PRICE_FEED: $--.------</div>
            </div>

            <div class="data-box">
                <div class="unit"><img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="large-icon"><span class="label-sub">ETH</span></div>
                <div style="font-weight: bold; color: #555;">>>>>></div>
                <div class="unit"><img src="https://paragraph.xyz/favicon.ico" class="large-icon" style="border-radius: 8px;"><span class="label-sub">$BTG</span></div>
            </div>

            <input type="number" id="ethIn" placeholder="AMOUNT IN ETH" step="0.01">
            <button class="btn-main" onclick="executeAction()" id="main-btn-v3">CONNECT_WALLET</button>
        </div>

        <div id="section-v1" class="hidden">
            <div style="font-size: 0.7rem; border-bottom: 1px solid var(--v1-neon); padding-bottom: 10px; margin-bottom: 20px;">> BIGTREE_DEEPTECH_OS</div>
            <div class="data-box" style="font-size: 0.6rem; flex-direction: column; align-items: flex-start;">
                <div>> XYLEM_PROTOCOL: <span style="color:#fff">ACTIVE</span></div>
                <div style="margin-top:5px;">> AUTH_STATUS: <span id="auth-status">ANONYMOUS</span></div>
                <div style="margin-top:5px;">> SYNC_LINK: <span id="sync-status" style="color: #444;">DISCONNECTED</span></div>
            </div>
            <button class="btn-main" id="main-btn-v1" onclick="handleCoreSync()">INIT_CORE_SYNC</button>
            <div style="font-size: 0.5rem; margin-top: 10px; opacity: 0.5;">AZURITE CALCULATOR v1.0 - INFOMANIAK NODE</div>
        </div>
    </div>

<script>
    const BTG_ADDR = "0x14e732bbba1cd07685d2081869ca5062ac32463a";
    const BASE_CHAIN_ID = '0x2105';
    let userAddress = null;
    let provider = null;

    function setMode(mode) {
        document.getElementById('terminal-master').className = mode + '-theme';
        document.getElementById('section-v3').classList.toggle('hidden', mode !== 'v3');
        document.getElementById('section-v1').classList.toggle('hidden', mode !== 'v1');
        document.getElementById('btn-v3').classList.toggle('active', mode === 'v3');
        document.getElementById('btn-v1').classList.toggle('active', mode === 'v1');
    }

    async function executeAction() {
        if (!window.ethereum) return alert("Install Metamask");
        
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];
            
            // Switch to Base
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: BASE_CHAIN_ID }],
            });

            await checkAccess();

            // Open Jumper
            const amount = document.getElementById('ethIn').value || "0.01";
            document.getElementById('jumper-iframe').src = `https://jumper.exchange/embed?variant=compact&fromChain=8453&toChain=8453&toToken=${BTG_ADDR}&fromAmount=${amount}&theme=dark`;
            document.getElementById('jumper-container').style.display = 'block';

        } catch (err) {
            console.error(err);
        }
    }

    async function checkAccess() {
        if (!userAddress) return;
        
        provider = new ethers.BrowserProvider(window.ethereum);
        const abi = ["function balanceOf(address) view returns (uint256)"];
        const contract = new ethers.Contract(BTG_ADDR, abi, provider);

        try {
            const bal = await contract.balanceOf(userAddress);
            const hasToken = bal > 0n;

            // UI Updates
            document.getElementById('auth-status').innerText = hasToken ? "VERIFIED_HOLDER" : "GUEST_READ_ONLY";
            document.getElementById('auth-status').style.color = hasToken ? "#00ff41" : "#ff4444";
            document.getElementById('sync-status').innerText = hasToken ? "READY_TO_LINK" : "LOCKED_BY_Xylem";
            document.getElementById('sync-status').style.color = hasToken ? "#fff" : "#444";
            
            document.getElementById('main-btn-v3').innerText = "OPEN_SWAP";
            document.getElementById('disconnect-btn').classList.remove('hidden');
        } catch (e) {
            console.error(e);
        }
    }

    function handleCoreSync() {
        const status = document.getElementById('auth-status').innerText;
        if (status === "VERIFIED_HOLDER") {
            alert("Accès autorisé. Connexion à Azurite-Infomaniak en cours...");
            // Ici on appellera ta Netlify Function
        } else {
            alert("Accès refusé. Token $BTG requis pour synchroniser le Core.");
            setMode('v3');
        }
    }

    function disconnectWallet() {
        userAddress = null;
        document.getElementById('main-btn-v3').innerText = "CONNECT_WALLET";
        document.getElementById('disconnect-btn').classList.add('hidden');
        document.getElementById('auth-status').innerText = "ANONYMOUS";
        document.getElementById('auth-status').style.color = "#fff";
    }

    function closeJumper() {
        document.getElementById('jumper-container').style.display = 'none';
        document.getElementById('jumper-iframe').src = '';
    }

    async function fetchPrice() {
        try {
            const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${BTG_ADDR}`);
            const data = await res.json();
            if(data.pairs) document.getElementById('btg-price').innerText = `PRICE_FEED: $${parseFloat(data.pairs[0].priceUsd).toFixed(6)}`;
        } catch(e) {}
    }

    setInterval(fetchPrice, 15000); fetchPrice();
</script>
</body>
</html>
