<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calculateur Force Proxy ΔP·V·(1-φ) – v1.2 (GPS stable)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --bg:#0f1216; --panel:#1a222b; --border:#27323d; --accent:#ffc94d; --accent2:#1f6feb;
  --text:#e6edf3; --muted:#76838f; --danger:#ff4d4d; --warn:#ffb347; --ok:#34d399;
  --map-h:200px; /* Hauteur carte réduite (modifier ici) */
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,sans-serif;
}
body{margin:0;background:linear-gradient(140deg,#101820,#0b0f14);color:var(--text);-webkit-font-smoothing:antialiased;}
h1{font-size:1.15rem;font-weight:600;letter-spacing:.6px;margin:.6rem 0 .7rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}
.badge{background:#13212d;color:#6fb2ff;padding:.3rem .7rem;border-radius:30px;font-size:.58rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
.badge.sim{background:#243946;color:#6fb2ff;}
.badge.csv{background:#44341a;color:#ffc94d;}
main{max-width:1320px;margin:0 auto;padding:1rem 1.1rem 3rem;box-sizing:border-box;}
section.box{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:1rem 1.15rem 1.25rem;box-shadow:0 6px 22px -12px rgba(0,0,0,.55);}
.grid{display:grid;gap:1rem;}
@media (min-width:1250px){.grid{grid-template-columns:380px 1fr;}}
label.lbl{display:flex;flex-direction:column;font-size:.63rem;letter-spacing:.5px;text-transform:uppercase;font-weight:600;color:var(--muted);gap:.32rem;}
input,select{background:#0f1921;color:var(--text);border:1px solid #2d3a46;border-radius:10px;padding:.5rem .6rem;font:inherit;outline:none;transition:.25s border;}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,201,77,.25);}
.row{display:grid;gap:.75rem;margin-bottom:.85rem;}
.cols-2{grid-template-columns:repeat(auto-fill,minmax(158px,1fr));}
button{cursor:pointer;border:none;font:inherit;font-weight:600;letter-spacing:.5px;
  background:linear-gradient(135deg,var(--accent),#ffd978);color:#402a00;padding:.65rem .9rem;border-radius:12px;
  box-shadow:0 4px 10px -5px rgba(0,0,0,.6);transition:.2s transform;}
button.secondary{background:linear-gradient(135deg,var(--accent2),#4aa3ff);color:#031a32;}
button.danger{background:linear-gradient(135deg,#ff6767,#ff3d3d);color:#300;}
button:active{transform:translateY(2px);}
button:disabled{opacity:.5;cursor:not-allowed;}
small.hint{font-size:.58rem;color:var(--muted);display:block;line-height:1.25;margin-top:.3rem;}
#phiBarWrap{background:#121c25;border:1px solid #283440;border-radius:10px;height:14px;overflow:hidden;position:relative;margin-top:.5rem;}
#phiBar{height:100%;width:0;background:var(--ok);transition:width .45s,background .4s;}
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(132px,1fr));gap:.55rem;margin-top:.85rem;}
.metric{background:#121c1f;padding:.5rem .55rem .55rem;border:1px solid #2a3641;border-radius:12px;min-width:0;}
.metric h4{margin:.1rem 0 .4rem;font-size:.6rem;color:var(--muted);letter-spacing:.45px;text-transform:uppercase;font-weight:600;}
.metric .v{font-size:.8rem;font-weight:600;letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.flex{display:flex;align-items:center;gap:.55rem;flex-wrap:wrap;}
.tabs{display:flex;gap:.4rem;margin-bottom:.65rem;flex-wrap:wrap;}
.tabs button{background:#18242d;color:#c9d2da;}
.tabs button.active{background:linear-gradient(135deg,#ffc94d,#ffdf95);color:#412b00;}
.sourceBadge{font-size:.58rem;padding:.25rem .5rem;border-radius:30px;font-weight:600;letter-spacing:.5px;display:inline-flex;align-items:center;gap:.35rem;}
.sourceBadge.sim{background:#243946;color:#6fb2ff;}
.sourceBadge.csv{background:#44341a;color:#ffc94d;}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,transparent,#293541,transparent);margin:1.05rem 0;}
table{width:100%;border-collapse:collapse;font-size:.6rem;}
th,td{padding:.38rem .45rem;text-align:right;}
th{background:#162029;position:sticky;top:0;z-index:2;font-weight:600;color:#c9d2da;border-bottom:1px solid #25313d;}
tbody tr:nth-child(even){background:#131f28;}
tbody tr:nth-child(odd){background:#0f1b24;}
tbody tr:hover{background:#1e2d38;}
td.time,th.time{text-align:left;}
.status{font-size:.58rem;letter-spacing:.45px;color:var(--muted);margin-top:.35rem;}
canvas.chart{width:100%;max-width:100%;height:280px;background:#091118;border:1px solid #1d2a33;border-radius:14px;}
footer{padding:1.2rem 1rem 2.2rem;text-align:center;font-size:.52rem;color:#6c7680;}
pre.code{background:#121c25;padding:.55rem .7rem;border:1px solid #283440;border-radius:12px;font-size:.6rem;overflow:auto;line-height:1.25;}
.csvConfig{background:#121c25;border:1px solid #27323d;border-radius:14px;padding:.6rem .7rem;margin-top:.55rem;}
.csvPreview{max-height:110px;overflow:auto;font-family:ui-monospace,Consolas,monospace;font-size:.58rem;line-height:1.25;background:#101820;border:1px solid #2a3641;border-radius:8px;padding:.35rem .5rem;margin-top:.35rem;}
.inlineNote{font-size:.52rem;color:#8a96a1;margin-top:.25rem;}
.speedSelect{background:#18242d;border:1px solid #2d3a46;color:#e6edf3;border-radius:10px;padding:.35rem .5rem;font-size:.6rem;}
/* GPS */
#gpsPanel small.hint { display:block; margin-top:.45rem; }
#map{
  width:100%; height:var(--map-h); position:relative; overflow:hidden;
  border:1px solid #27323d; border-radius:14px; background:#0b141c;
}
.leaflet-container{ background:#0b141c; font:inherit; }
#gpsPanel{transform:none!important;will-change:auto!important;}
</style>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoSgLibJEiwQ3s=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
<main>
  <h1>Calculateur Force Proxy ΔP·V·(1-φ) <span class="badge">v1.2</span> <span id="sourceBadge" class="sourceBadge sim">SOURCE: Simulation</span></h1>
  <div class="grid">
    <!-- Paramètres -->
    <section class="box">
      <div class="tabs" id="sourceTabs">
        <button data-mode="simulation" class="active">Simulation</button>
        <button data-mode="csv">Fichier CSV</button>
      </div>

      <div id="simulationPanel">
        <div class="row cols-2">
          <label class="lbl">Fluide
            <select id="fluid">
              <option value="air" selected>Air</option>
              <option value="eau">Eau</option>
            </select>
          </label>
          <label class="lbl">Gaz interne
            <select id="gas">
              <option value="helium" selected>Hélium</option>
              <option value="hydrogen">Hydrogène</option>
              <option value="air">Air</option>
            </select>
          </label>
          <label class="lbl">Masse nacelle (kg)
            <input id="massNac" type="number" step="0.01" value="5">
          </label>
          <label class="lbl">Volume initial V₀ (m³)
            <input id="volInit" type="number" step="0.01" value="8">
          </label>
          <label class="lbl">P₀ référence (Pa)
            <input id="pref" type="number" step="1" value="101325">
          </label>
          <label class="lbl">Température init (K)
            <input id="tempInit" type="number" step="0.1" value="293.15">
          </label>
            <label class="lbl">Pression init (Pa)
            <input id="pressInit" type="number" step="1" value="101325">
          </label>
          <label class="lbl">Taille historique
            <input id="histSize" type="number" step="10" value="600">
          </label>
        </div>
        <div class="flex">
          <button id="initBtn">Initialiser</button>
          <button id="resetBtn" class="secondary">Reset</button>
          <label style="font-size:.55rem;display:flex;align-items:center;gap:.3rem;">
            <input type="checkbox" id="emaToggle"> Lissage ΔP (EMA)
          </label>
        </div>
        <small class="hint">F = (P - P₀)·V·(1 - ρglob/ρfluide) – Simulation sinus interne.</small>
      </div>

      <div id="csvPanel" style="display:none;">
        <div class="csvConfig">
          <strong style="font-size:.65rem;letter-spacing:.5px;">Import CSV</strong>
          <div class="flex" style="margin-top:.45rem;">
            <input type="file" id="csvInput" accept=".csv" style="flex:1;">
            <select id="csvSpeed" class="speedSelect" title="Vitesse lecture">
              <option value="1">1x</option><option value="0.5">0.5x</option>
              <option value="2">2x</option><option value="5">5x</option>
            </select>
            <button id="csvPlayBtn" disabled>Play</button>
            <button id="csvPauseBtn" class="secondary" disabled>Pause</button>
            <button id="csvResetBtn" class="danger" disabled>Reset</button>
          </div>
          <div class="row cols-2" style="margin-top:.5rem;">
            <label class="lbl">Col Time
              <select id="colTime"></select>
            </label>
            <label class="lbl">Col Pression (Pa)
              <select id="colP"></select>
            </label>
            <label class="lbl">Col Température
              <select id="colT"></select>
            </label>
            <label class="lbl">Temp en
              <select id="tempUnit">
                <option value="K">K</option><option value="C">°C</option>
              </select>
            </label>
          </div>
          <button id="applyMappingBtn" class="secondary" disabled>Appliquer Mapping</button>
          <div class="inlineNote" id="csvInfo">Aucun fichier chargé.</div>
          <div class="csvPreview" id="csvPreview"></div>
          <small class="hint">1. Fichier → 2. Colonnes → 3. Appliquer → 4. Play.</small>
        </div>
      </div>

      <hr class="sep">
      <div id="phiBarWrap"><div id="phiBar"></div></div>
      <div class="metrics">
        <div class="metric"><h4>ΔP (Pa)</h4><div class="v" id="deltaPVal">—</div></div>
        <div class="metric"><h4>V (m³)</h4><div class="v" id="volVal">—</div></div>
        <div class="metric"><h4>φ</h4><div class="v" id="phiVal">—</div></div>
        <div class="metric"><h4>ψ = 1 - φ</h4><div class="v" id="psiVal">—</div></div>
        <div class="metric"><h4>F (proxy N)</h4><div class="v" id="forceVal">—</div></div>
      </div>
      <div class="status" id="status">Status: initialiser ou charger un CSV.</div>
    </section>

    <!-- Graphique & Tableau -->
    <section class="box">
      <canvas id="forceChart" class="chart"></canvas>
      <hr class="sep">
      <div style="max-height:330px;overflow:auto;border:1px solid var(--border);border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th class="time">Time</th><th>P (Pa)</th><th>ΔP</th><th>T (K)</th><th>V (m³)</th>
              <th>ρ_glob</th><th>ρ_fluide</th><th>φ</th><th>ψ</th><th>F</th><th>Source</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="flex" style="margin-top:.6rem;">
        <button id="exportBtn" class="secondary">Exporter CSV (résultats)</button>
        <span id="rowsInfo" style="font-size:.55rem;color:var(--muted);"></span>
      </div>
    </section>
  </div>

  <!-- GPS séparé (PAS imbriqué) -->
  <section class="box" id="gpsPanel" style="margin-top:1rem;">
    <h2 style="margin:0 0 .55rem;font-size:.85rem;font-weight:600;letter-spacing:.5px;">GPS / Carte</h2>
    <div class="flex" style="margin-bottom:.5rem;">
      <button id="gpsToggleBtn" class="secondary">Activer GPS</button>
      <span id="gpsStatus" style="font-size:.55rem;color:#8aa0b2;">Inactif.</span>
    </div>
    <div id="map"></div>
    <small class="hint">Local uniquement. Cliquer de nouveau pour arrêter. Hauteur réduite pour stabilité mobile.</small>
  </section>

  <section class="box" style="margin-top:1rem;">
    <h2 style="margin:.15rem 0 .65rem;font-size:.95rem;font-weight:600;letter-spacing:.5px;">Notes & Formule</h2>
    <pre class="code">F = (P - P0) · V · (1 - φ)
φ = ρ_glob / ρ_fluide
ψ = 1 - φ
ρ_glob = (m_nac + m_gaz) / V
V = m_gaz / ρ_gaz ; ρ_gaz = P / (R_gaz T)
ρ_fluide (air) = P / (R_air T) ; eau ~ 1000 kg/m³
Simulation: P(t)=P0 - 2000 sin(t/120); T(t)=T0 + 3 sin(t/180)
CSV: lecture progressive, vitesse ajustable.</pre>
  </section>
</main>
<footer>Prototype v1.2 + GPS stable (carte réduite). © BigTree</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* === Constantes gaz === */
const R_AIR=287.05;
const R={helium:2077, hydrogen:4124, air:R_AIR};

/* === État global === */
const state={initialized:false,mGas:0,mNac:0,V0:0,P0:101325,history:[],emaDeltaP:null,mode:'simulation'};

/* === Sélecteurs === */
const els={
  sourceTabs:document.getElementById('sourceTabs'),
  simulationPanel:document.getElementById('simulationPanel'),
  csvPanel:document.getElementById('csvPanel'),
  sourceBadge:document.getElementById('sourceBadge'),
  fluid:fluid, gas:gas, massNac:massNac, volInit:volInit, pref:pref,
  tempInit:tempInit, pressInit:pressInit, histSize:histSize, emaToggle:emaToggle,
  initBtn:initBtn, resetBtn:resetBtn,
  csvInput:csvInput, csvPreview:csvPreview, csvInfo:csvInfo,
  colTime:colTime, colP:colP, colT:colT, tempUnit:tempUnit,
  applyMappingBtn:applyMappingBtn, csvPlayBtn:csvPlayBtn, csvPauseBtn:csvPauseBtn,
  csvResetBtn:csvResetBtn, csvSpeed:csvSpeed,
  deltaPVal:deltaPVal, volVal:volVal, phiVal:phiVal, psiVal:psiVal, forceVal:forceVal,
  status:status, phiBar:phiBar,
  histBody:histBody, rowsInfo:rowsInfo, exportBtn:exportBtn
};
let forceChart=null;

/* === Source Manager === */
const dataSourceManager={
  simFrame:0, simActive:false,
  csv:{rawLines:[],header:[],rows:[],mapped:false,playing:false,idx:0,timer:null},
  setMode(mode){
    if(state.mode===mode)return;
    if(state.mode==='simulation') this.stopSimulation();
    if(state.mode==='csv') this.stopCSV();
    state.mode=mode; updateSourceUI();
  },
  startSimulation(){
    if(!state.initialized)return;
    this.simActive=true;
    els.status.textContent='Simulation en cours…';
    const loop=()=>{
      if(!this.simActive||state.mode!=='simulation'||!state.initialized)return;
      this.simFrame++;
      const t=this.simFrame;
      const P=state.P0 - 2000*Math.sin(t/120);
      const T0=parseFloat(els.tempInit.value)||293.15;
      const T=T0 + 3*Math.sin(t/180);
      ingestSample({P,T,timestamp:Date.now(),src:'SIM'});
      requestAnimationFrame(loop);
    };
    loop();
  },
  stopSimulation(){this.simActive=false;els.status.textContent='Simulation arrêtée.';},
  loadCSV(text){
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
    this.csv.rawLines=lines;
    this.csv.header=lines[0].split(/[,;\t]/);
    this.csv.rows=lines.slice(1).map(l=>l.split(/[,;\t]/));
    this.csv.mapped=false;this.csv.idx=0;
    this.populateMappingSelectors();this.previewCSV();
    els.csvInfo.textContent=`${this.csv.rows.length} lignes chargées. Sélectionner colonnes puis Appliquer.`;
    els.applyMappingBtn.disabled=false;
  },
  populateMappingSelectors(){
    [els.colTime,els.colP,els.colT].forEach(sel=>sel.innerHTML='<option value="">(Aucune)</option>');
    this.csv.header.forEach((h,i)=>{
      ['colTime','colP','colT'].forEach(id=>{
        const o=document.createElement('option');o.value=i;o.textContent=`${i}: ${h}`;
        els[id].appendChild(o.cloneNode(true));
      });
    });
  },
  applyMapping(){
    const pIdx=parseInt(els.colP.value), tIdx=parseInt(els.colT.value);
    if(Number.isNaN(pIdx)||Number.isNaN(tIdx)){els.csvInfo.textContent='Mapping invalide (pression + température).';return;}
    this.csv.mapped=true;this.csv.idx=0;
    els.csvInfo.textContent='Mapping appliqué. Prêt.';
    els.csvPlayBtn.disabled=false;els.csvPauseBtn.disabled=true;els.csvResetBtn.disabled=false;
    els.status.textContent='CSV prêt (Pause).';
  },
  previewCSV(){
    const head=this.csv.header.join(' | ');
    const body=this.csv.rows.slice(0,5).map(r=>r.join(' | '));
    els.csvPreview.textContent=[head,...body].join('\\n');
  },
  playCSV(){
    if(!this.csv.mapped||this.csv.playing)return;
    if(!state.initialized){try{initModel();els.status.textContent='Auto-init CSV…';}catch(e){els.status.textContent='Auto-init échec: '+e.message;return;}}
    this.stopSimulation();
    this.csv.playing=true;
    els.csvPlayBtn.disabled=true;els.csvPauseBtn.disabled=false;
    const speed=parseFloat(els.csvSpeed.value)||1;
    const interval=500/speed;
    const pIdx=parseInt(els.colP.value), tIdx=parseInt(els.colT.value);
    const timeIdx=els.colTime.value===''?null:parseInt(els.colTime.value);
    const tempUnit=els.tempUnit.value;
    els.status.textContent='Lecture CSV…';
    const step=()=>{
      if(!this.csv.playing||state.mode!=='csv')return;
      if(this.csv.idx>=this.csv.rows.length){
        this.csv.playing=false;els.csvPlayBtn.disabled=false;els.csvPauseBtn.disabled=true;
        els.status.textContent='Lecture CSV terminée.';return;
      }
      const row=this.csv.rows[this.csv.idx];
      const P=parseFloat(row[pIdx]);let T=parseFloat(row[tIdx]);
      if(tempUnit==='C')T+=273.15;
      let timestamp=Date.now();
      if(timeIdx!==null){const raw=row[timeIdx];const pd=Date.parse(raw);if(!isNaN(pd))timestamp=pd;}
      if(isFinite(P)&&isFinite(T)&&P>0&&T>0) ingestSample({P,T,timestamp,src:'CSV'});
      this.csv.idx++;this.csv.timer=setTimeout(step,interval);
    };
    step();
  },
  pauseCSV(){
    if(!this.csv.playing)return;
    this.csv.playing=false;
    if(this.csv.timer)clearTimeout(this.csv.timer);
    els.csvPlayBtn.disabled=false;els.csvPauseBtn.disabled=true;
    els.status.textContent='Lecture CSV en pause.';
  },
  resetCSV(){
    if(this.csv.timer)clearTimeout(this.csv.timer);
    this.csv.idx=0;this.csv.playing=false;
    els.csvPlayBtn.disabled=!this.csv.mapped;els.csvPauseBtn.disabled=true;
    els.status.textContent='Lecture CSV réinitialisée.';
  },
  stopCSV(){if(this.csv.timer)clearTimeout(this.csv.timer);this.csv.playing=false;}
};

/* === Événements === */
els.sourceTabs.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON')return;
  const mode=e.target.getAttribute('data-mode');
  document.querySelectorAll('#sourceTabs button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  dataSourceManager.setMode(mode);
});
els.initBtn.addEventListener('click',()=>{
  try{initModel();els.status.textContent='Initialisé.';if(state.mode==='simulation')dataSourceManager.startSimulation();}
  catch(e){els.status.textContent='Erreur init: '+e.message;}
});
els.resetBtn.addEventListener('click',resetModel);
els.exportBtn.addEventListener('click',exportResultsCSV);
els.csvInput.addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=evt=>dataSourceManager.loadCSV(evt.target.result);r.readAsText(f);
});
els.applyMappingBtn.addEventListener('click',()=>dataSourceManager.applyMapping());
els.csvPlayBtn.addEventListener('click',()=>dataSourceManager.playCSV());
els.csvPauseBtn.addEventListener('click',()=>dataSourceManager.pauseCSV());
els.csvResetBtn.addEventListener('click',()=>dataSourceManager.resetCSV());
els.csvSpeed.addEventListener('change',()=>{
  if(dataSourceManager.csv.playing){dataSourceManager.pauseCSV();dataSourceManager.playCSV();}
});

/* === UI mode === */
function updateSourceUI(){
  if(state.mode==='simulation'){
    els.simulationPanel.style.display='';
    els.csvPanel.style.display='none';
    els.sourceBadge.textContent='SOURCE: Simulation';
    els.sourceBadge.className='sourceBadge sim';
    if(state.initialized && !dataSourceManager.simActive) dataSourceManager.startSimulation();
  } else {
    els.simulationPanel.style.display='none';
    els.csvPanel.style.display='';
    els.sourceBadge.textContent='SOURCE: CSV';
    els.sourceBadge.className='sourceBadge csv';
    dataSourceManager.stopSimulation();
  }
}

/* === Init / Reset === */
function initModel(){
  state.mNac=parseFloat(els.massNac.value)||0;
  state.V0=parseFloat(els.volInit.value)||0;
  state.P0=parseFloat(els.pref.value)||101325;
  const T0=parseFloat(els.tempInit.value)||293.15;
  const Pinit=parseFloat(els.pressInit.value)||state.P0;
  const gas=els.gas.value, Rgas=R[gas];
  if(state.V0<=0)throw new Error('Volume initial invalide');
  if(Pinit<=0)throw new Error('Pression initiale invalide');
  if(T0<=0)throw new Error('Température initiale invalide');
  const rho_gaz0=Pinit/(Rgas*T0);
  state.mGas=rho_gaz0*state.V0;
  state.initialized=true;
  state.history=[];state.emaDeltaP=null;
  setupChart();clearTable();
}
function resetModel(){
  state.initialized=false;state.history=[];state.mGas=0;state.emaDeltaP=null;
  dataSourceManager.stopSimulation();dataSourceManager.stopCSV();
  updateDisplays(null);
  if(forceChart){forceChart.data.labels=[];forceChart.data.datasets[0].data=[];forceChart.update();}
  clearTable();els.status.textContent='Reset effectué.';
}

/* === Ingestion / calcul === */
function ingestSample(sample){
  const {P,T,timestamp,src}=sample;
  if(P<=0||T<=0||!state.initialized)return;
  const m=computeMetrics(P,T);
  appendHistory(m,timestamp,src||state.mode.toUpperCase());
  updateDisplays(m);updateChart(m);updateTable(m,timestamp,src||state.mode.toUpperCase());
}
function computeMetrics(P,T){
  const gas=els.gas.value, fluid=els.fluid.value, Rgas=R[gas];
  let deltaP=P-state.P0;
  if(els.emaToggle.checked){
    const a=0.2;
    state.emaDeltaP=state.emaDeltaP==null?deltaP:a*deltaP+(1-a)*state.emaDeltaP;
    deltaP=state.emaDeltaP;
  }
  const rho_fluid = (fluid==='air') ? P/(R_AIR*T) : 1000;
  const rho_gaz = P/(Rgas*T);
  const V = state.mGas / rho_gaz;
  const rho_glob=(state.mNac+state.mGas)/V;
  const phi=rho_glob/rho_fluid;
  const psi=1-phi;
  const F=deltaP*V*psi;
  return {P,T,deltaP,V,rho_glob,rho_fluid,phi,psi,F};
}

/* === Historique === */
function appendHistory(m,ts,src){
  const maxSize=parseInt(els.histSize.value)||600;
  state.history.push({...m,ts,source:src});
  if(state.history.length>maxSize)state.history.splice(0,state.history.length-maxSize);
}

/* === Affichage === */
function updateDisplays(m){
  if(!m){
    ['deltaPVal','volVal','phiVal','psiVal','forceVal'].forEach(id=>els[id].textContent='—');
    els.phiBar.style.width='0%';return;
  }
  els.deltaPVal.textContent=m.deltaP.toFixed(2);
  els.volVal.textContent=m.V.toFixed(3);
  els.phiVal.textContent=m.phi.toFixed(3);
  els.psiVal.textContent=m.psi.toFixed(3);
  els.forceVal.textContent=m.F.toExponential(3);
  const phiClamped=Math.max(0,Math.min(m.phi,2));
  els.phiBar.style.width=(phiClamped/2*100)+'%';
  els.phiBar.style.background=m.phi>1.05?'#ff4d4d':(m.phi>0.95?'#ffb347':'#34d399');
  let st=`Source: ${state.mode}`; if(m.psi<0) st+=' | ψ < 0 (Surcharge)';
  els.status.textContent=st;
}

/* === Chart === */
function setupChart(){
  const ctx=document.getElementById('forceChart').getContext('2d');
  if(forceChart)forceChart.destroy();
  forceChart=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:'F proxy',data:[],borderColor:'#ffc94d',backgroundColor:'rgba(255,201,77,0.15)',tension:.25,pointRadius:0}]},
    options:{animation:false,responsive:true,plugins:{legend:{display:false}},scales:{x:{display:true},y:{display:true}}}
  });
}
function updateChart(m){
  if(!forceChart)return;
  const lbl=new Date().toLocaleTimeString();
  forceChart.data.labels.push(lbl);
  forceChart.data.datasets[0].data.push(m.F);
  if(forceChart.data.labels.length>600){
    forceChart.data.labels.shift();forceChart.data.datasets[0].data.shift();
  }
  forceChart.update('none');
}

/* === Tableau === */
function clearTable(){els.histBody.innerHTML='';els.rowsInfo.textContent='';}
function updateTable(m,ts,src){
  const tr=document.createElement('tr');
  const tStr=new Date(ts).toLocaleTimeString();
  const cell=(v,dec=3)=>(typeof v==='number'?v.toFixed(dec):v);
  tr.innerHTML=`
    <td class="time">${tStr}</td>
    <td>${cell(m.P,1)}</td>
    <td>${cell(m.deltaP,1)}</td>
    <td>${cell(m.T,2)}</td>
    <td>${cell(m.V,3)}</td>
    <td>${cell(m.rho_glob,3)}</td>
    <td>${cell(m.rho_fluid,3)}</td>
    <td>${cell(m.phi,3)}</td>
    <td>${cell(m.psi,3)}</td>
    <td>${m.F.toExponential(3)}</td>
    <td>${src||state.mode}</td>`;
  els.histBody.prepend(tr);
  els.rowsInfo.textContent=els.histBody.querySelectorAll('tr').length+' points';
}

/* === Export CSV === */
function exportResultsCSV(){
  if(!state.history.length){alert('Pas de données.');return;}
  const header=['Time','Timestamp','Source','P','DeltaP','T','V','rho_glob','rho_fluid','phi','psi','F'];
  const lines=[header.join(',')];
  state.history.forEach(r=>{
    lines.push([
      new Date(r.ts).toISOString(),r.ts,r.source,
      r.P.toFixed(4),r.deltaP.toFixed(4),r.T.toFixed(4),
      r.V.toFixed(6),r.rho_glob.toFixed(6),r.rho_fluid.toFixed(6),
      r.phi.toFixed(6),r.psi.toFixed(6),r.F
    ].join(','));
  });
  const blob=new Blob([lines.join('\\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='force_proxy_results_'+new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]+'.csv';
  a.click();URL.revokeObjectURL(url);
}

/* === GPS (stable, carte réduite) === */
let gpsActive=false,gpsWatchId=null,mapInst=null,gpsMarker=null,gpsPolyline=null,firstFix=true;

function initMap(){
  if(mapInst)return;
  mapInst=L.map('map',{center:[0,0],zoom:2,zoomControl:true,attributionControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,attribution:'© OpenStreetMap'
  }).addTo(mapInst);
  gpsMarker=L.marker([0,0]).addTo(mapInst);
  gpsPolyline=L.polyline([], {color:'#ffc94d',weight:3}).addTo(mapInst);
  setTimeout(()=>mapInst.invalidateSize(),180);
}

function toggleGPS(){
  const statusEl=document.getElementById('gpsStatus');
  const btn=document.getElementById('gpsToggleBtn');
  if(!navigator.geolocation){statusEl.textContent='GPS non supporté';return;}
  if(!gpsActive){
    initMap(); gpsActive=true; firstFix=true;
    btn.textContent='Arrêter GPS'; statusEl.textContent='Activation GPS…';
    gpsWatchId=navigator.geolocation.watchPosition(onGPS,onGPSError,{
      enableHighAccuracy:true,maximumAge:1000,timeout:15000
    });
  } else {
    gpsActive=false;
    if(gpsWatchId!==null){navigator.geolocation.clearWatch(gpsWatchId);gpsWatchId=null;}
    btn.textContent='Activer GPS'; statusEl.textContent='Inactif.';
  }
}
function onGPS(pos){
  const {latitude,longitude}=pos.coords;
  gpsMarker.setLatLng([latitude,longitude]);
  gpsPolyline.addLatLng([latitude,longitude]);
  if(firstFix){
    mapInst.setView([latitude,longitude],6);
    firstFix=false;
    setTimeout(()=>mapInst.invalidateSize(),220);
  } else {
    mapInst.panTo([latitude,longitude],{animate:true});
  }
  document.getElementById('gpsStatus').textContent=`Lat: ${latitude.toFixed(5)} Lon: ${longitude.toFixed(5)}`;
}
function onGPSError(err){
  document.getElementById('gpsStatus').textContent='Erreur: '+err.message;
}
document.getElementById('gpsToggleBtn').addEventListener('click',toggleGPS);
window.addEventListener('orientationchange',()=>{ if(mapInst) setTimeout(()=>mapInst.invalidateSize(),350); });

/* === Démarrage === */
updateSourceUI();
</script>
</body>
</html>
