
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte Azimutale - Astres corrigés</title>
  <style>
    body {
      background: #000;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 1em;
    }
    #map-container {
      position: relative;
      width: 1600px;
      height: 1600px;
      margin: 2em auto;
    }
    #map {
      width: 100%;
      height: 100%;
      display: block;
    }
    .point {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .sun { background-color: orange; }
    .moon { background-color: cyan; }
    .interpolated-sun {
      width: 18px;
      height: 18px;
      background-color: orange;
      border: 2px solid black;
      z-index: 10;
    }
    .interpolated-moon {
      width: 18px;
      height: 18px;
      background-color: cyan;
      border: 2px solid black;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>Carte Azimutale - Soleil & Lune (Corrigé)</h1>
  <div id="map-container">
    <img id="map" src="azimuth-map.jpg" alt="Carte Azimutale">
  </div>

  <script>
    const centerX = 800;
    const centerY = 800;
    const mapContainer = document.getElementById("map-container");

    const gpsPoints = [];

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function loadPointsAndRender() {
      const points = gpsPoints;
      const enriched = [];

      for (const pt of points) {
        try {
          const url = `https://syncrolink-server.onrender.com/sunmoon?lat=${pt.latitude}&lon=${pt.longitude}`;
          const res = await fetch(url);
          const data = await res.json();
          enriched.push({
            ...pt,
            sunAlt: data.sunAltitude,
            moonAlt: data.moonAltitude
          });
        } catch (e) {
          console.warn("Erreur API pour", pt.latitude, pt.longitude);
        }
        await delay(100); // petit délai pour ne pas saturer l’API
      }

      const sunTop = [...enriched].filter(p => p.sunAlt > 0).sort((a, b) => b.sunAlt - a.sunAlt).slice(0, 4);
      const moonTop = [...enriched].filter(p => p.moonAlt > 0).sort((a, b) => b.moonAlt - a.moonAlt).slice(0, 4);

      sunTop.forEach(pt => {
        const el = document.createElement("div");
        el.className = "point sun";
        el.style.left = `${pt.x}px`;
        el.style.top = `${pt.y}px`;
        mapContainer.appendChild(el);
      });

      moonTop.forEach(pt => {
        const el = document.createElement("div");
        el.className = "point moon";
        el.style.left = `${pt.x}px`;
        el.style.top = `${pt.y}px`;
        mapContainer.appendChild(el);
      });

      const interpolate = (pts, key) => {
        let sumX = 0, sumY = 0, sumW = 0;
        pts.forEach(p => {
          const w = Math.max(0, p[key]);
          sumX += p.x * w;
          sumY += p.y * w;
          sumW += w;
        });
        return sumW > 0 ? { x: sumX / sumW, y: sumY / sumW } : null;
      };

      const sunInterp = interpolate(sunTop, 'sunAlt');
      if (sunInterp) {
        const el = document.createElement("div");
        el.className = "point interpolated-sun";
        el.style.left = `${sunInterp.x}px`;
        el.style.top = `${sunInterp.y}px`;
        mapContainer.appendChild(el);
      }

      const moonInterp = interpolate(moonTop, 'moonAlt');
      if (moonInterp) {
        const el = document.createElement("div");
        el.className = "point interpolated-moon";
        el.style.left = `${moonInterp.x}px`;
        el.style.top = `${moonInterp.y}px`;
        mapContainer.appendChild(el);
      }
    }

    fetch("points_gps_azimutaux.csv")
      .then(r => r.text())
      .then(text => {
        const lines = text.trim().split("\n").slice(1);
        for (const line of lines) {
          const [latitude, longitude, x, y, cercle] = line.split(",");
          gpsPoints.push({
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude),
            x: parseFloat(x),
            y: parseFloat(y),
            cercle: parseInt(cercle)
          });
        }
        loadPointsAndRender();
      });
  </script>
</body>
</html>
