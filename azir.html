<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🌞 Calibrage Carte Azimutale</title>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; }
    #mapContainer { position: relative; display: inline-block; margin: 20px auto; }
    #map { max-width: 90%; display: block; }
    .marker {
      position: absolute; width: 16px; height: 16px;
      border-radius: 50%; transform: translate(-50%,-50%);
    }
    .marker.sun  { background: yellow; }
    .marker.moon { background: cyan;   }
    #controls { margin: 10px auto; }
    #controls label { display: inline-block; margin: 0 10px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>

  <h1>Calibrage Carte Azimutale</h1>

  <!-- Curseurs de calibration -->
  <div id="controls">
    <label>dx : <input id="dx" type="range" min="-200" max="200" value="0"></label>
    <label>dy : <input id="dy" type="range" min="-200" max="200" value="0"></label>
    <label>scale : <input id="scaleR" type="range" min="0.5" max="1.5" step="0.01" value="1"></label>
  </div>

  <!-- Carte et marqueurs -->
  <div id="mapContainer">
    <img id="map" src="images/map_azimutal.jpeg" alt="Carte azimutale">
    <div class="marker sun"  style="display:none"></div>
    <div class="marker moon" style="display:none"></div>
  </div>
  <div id="status">Chargement…</div>

  <script>
    // Récupère les éléments
    const dxInput    = document.getElementById("dx");
    const dyInput    = document.getElementById("dy");
    const scaleInput = document.getElementById("scaleR");
    const statusEl   = document.getElementById("status");
    const mapImg     = document.getElementById("map");
    const sunEl      = document.querySelector(".marker.sun");
    const moonEl     = document.querySelector(".marker.moon");

    // Fonction de dessin (Soleil + Lune)
    async function draw() {
      statusEl.textContent = "Chargement…";
      let data;
      try {
        const res = await fetch(
          `https://syncrolink-server.onrender.com/sunmoon?lat=48.8566&lon=2.3522`
        );
        if (!res.ok) throw new Error(`Status ${res.status}`);
        data = await res.json();
      } catch (err) {
        statusEl.textContent = `❌ Erreur fetch : ${err.message}`;
        return;
      }

      if (!mapImg.complete) await new Promise(r => mapImg.onload = r);

      // Dimensions et paramètres ajustables
      const w      = mapImg.naturalWidth;
      const h      = mapImg.naturalHeight;
      const dx     = parseFloat(dxInput.value);
      const dy     = parseFloat(dyInput.value);
      const scaleR = parseFloat(scaleInput.value);

      // Calcule centre et rayon ajustés
      const cx = w/2 + dx;
      const cy = h/2 + dy;
      const R  = (Math.min(w,h)/2) * scaleR;

      // Pour chaque azimut, calcule position et affiche
      [
        { az: data.sunAzimuth, el: sunEl,  name: "Soleil" },
        { az: data.moonAzimuth, el: moonEl, name: "Lune"   }
      ].forEach(({az, el, name}) => {
        const x = cx + R * Math.sin(az);
        const y = cy + R * Math.cos(az);
        Object.assign(el.style, {
          left:      x + "px",
          top:       y + "px",
          display:   "block"
        });
      });

      statusEl.textContent = "Points placés ! Ajuste si besoin.";
    }

    // Re-dessine à chaque modification des curseurs
    [dxInput, dyInput, scaleInput].forEach(inp =>
      inp.addEventListener("input", draw)
    );

    // Premier dessin au chargement
    draw();
  </script>
</body>
</html>
