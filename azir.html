<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ğŸŒ & ğŸŒ™ Carte Azimutale + Altitude â†’ Latitude/Longitude cÃ©lestes</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; text-align:center; }
    #mapC { position:relative; width:660px; height:660px; margin:20px auto; }
    #map  { position:absolute; top:0; left:0; width:660px; height:660px; }
    .mkr { position:absolute; width:16px;height:16px;border-radius:50%;transform:translate(-50%,-50%);display:none; }
    .mkr.sun  { background: yellow; border:2px solid orange; }
    .mkr.moon { background: cyan;   border:2px solid blue;   }
    #status { margin-top:10px; }
  </style>
</head>
<body>
  <h1>ğŸŒ & ğŸŒ™ Carte Terre-Plate (V1)</h1>
  <div id="mapC">
    <img id="map" src="images/map_azimutal.jpeg" alt="660Ã—660">
    <div class="mkr sun"></div>
    <div class="mkr moon"></div>
  </div>
  <div id="status">Chargementâ€¦</div>

  <script>
  (async ()=> {
    const status = document.getElementById('status');
    // 1) RÃ©cupÃ¨re Azimut & Altitude depuis ton API
    let data;
    try {
      const r = await fetch(
        'https://syncrolink-server.onrender.com/sunmoon?lat=48.8566&lon=2.3522'
      );
      if (!r.ok) throw new Error('Status '+r.status);
      data = await r.json();
    } catch(e) {
      return status.textContent = 'âŒ API : '+e.message;
    }

    // 2) Convertis tout en radians
    const Ï†0 = 48.8566 * Math.PI/180; // latitude observateur
    const astres = [
      { az: data.sunAzimuth,   alt: data.sunAltitude,   cls: 'sun' },
      { az: data.moonAzimuth,  alt: data.moonAltitude,  cls: 'moon'}
    ];

    // 3) Calcul trigonomÃ©trique pour chaque astre :
    //    Î´ = arcsin( sin(alt)*sin(Ï†0) + cos(alt)*cos(Ï†0)*cos(az) )
    //    H = atan2( -sin(az)*cos(alt),
    //                cos(Ï†0)*sin(alt) - sin(Ï†0)*cos(alt)*cos(az) )
    // H est l'heure angulaire (longitude cÃ©leste), positif vers l'Ouest.
    function calcDeclHour(az, alt) {
      const sA = Math.sin(alt), cA = Math.cos(alt),
            s0 = Math.sin(Ï†0), c0 = Math.cos(Ï†0);
      const decl = Math.asin( sA*s0 + cA*c0*Math.cos(az) );
      const H    = Math.atan2(
        -Math.sin(az)*cA,
         c0*sA - s0*cA*Math.cos(az)
      );
      return { decl, H };
    }

    // 4) Place sur la carte
    const cx = 330, cy = 330, R = 330;
    await new Promise(r => {
      const img = document.getElementById('map');
      if (img.complete) return r();
      img.onload = r;
    });

    astres.forEach(({az, alt, cls})=>{
      const {decl, H} = calcDeclHour(az, alt);
      // colatitude = Ï€/2 - decl â†’ de 0 (pÃ´le Nord) Ã  Ï€ (pÃ´le Sud)
      const colat = Math.PI/2 - decl;
      const rpx   = (colat/Math.PI)*R;
      // coordonnÃ©es
      const x = cx + rpx*Math.sin(H),
            y = cy + rpx*Math.cos(H);
      const el = document.querySelector('.mkr.'+cls);
      el.style.left    = x+'px';
      el.style.top     = y+'px';
      el.style.display = 'block';
    });

    status.textContent = 'âœ”ï¸ Soleil & Lune placÃ©s selon declination & horaire';
  })();
  </script>
</body>
</html>
